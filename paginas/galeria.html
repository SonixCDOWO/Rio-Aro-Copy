<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Galería de Imágenes</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
    <link rel="stylesheet" href="/assets/css/Navs&Headers.css">
    <link rel="stylesheet" href="/assets/css/Sidebar.css">

    <style>
        :root {
            --primary-color: #3b82f6;
            --secondary-color: #2563eb;
            --btn-main-color: #e3b707;
            --btn-hover-color: #eab308;
            --text-dark-color: #333;
            --text-light-color: #fff;
            --card-bg: #fff;
            --background-gradient: linear-gradient(120deg, var(--primary-color), var(--secondary-color));
            --font-stack: 'Segoe UI', Arial, sans-serif;
        }
        body {
            font-family: var(--font-stack);
            background: var(--background-gradient);
            min-height: 100vh;
            margin: 0;
            color: var(--text-dark-color);
            display: flex;
            flex-direction: column;
        }
        main.container {
            flex: 1;
            max-width: 1200px;
            margin: 20px auto;
            padding: 20px;
            background-color: rgba(255,255,255,0.95);
            border-radius: 16px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }
        h1, h2 {
            color: var(--primary-color);
            border-bottom: 2px solid var(--btn-main-color);
            padding-bottom: 10px;
            margin-bottom: 20px;
        }
        h2 {
            width: 50%;
            margin-left: auto;
            margin-right: auto;
        }
        .wii-icon {
            width: 150px;
            height: 150px;
            margin: 15px;
            border-radius: 20px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            transition: transform 0.3s ease;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: #fff;
            position: relative;
        }
        .wii-icon:hover {
            transform: scale(1.05);
            box-shadow: 0 8px 20px rgba(0,0,0,0.2);
        }
        .wii-icon img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .gallery-container {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            padding-top: 20px;
        }
        .delete-btn {
            position: absolute;
            top: 5px;
            right: 5px;
            background-color: rgba(255,0,0,0.7);
            color: white;
            border: none;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.1em;
            cursor: pointer;
            z-index: 10;
        }
        .delete-btn:hover {
            background-color: rgba(255,0,0,1);
        }
        .modal-body img {
            max-width: 100%;
            height: auto;
            display: block;
            margin: auto;
        }
        .upload-section {
            background-color: #f0f8ff;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }

        /* --- Estilos para la Cronología --- */
        .timeline-container {
            position: relative;
            max-width: 900px;
            margin: 0 auto;
            padding: 40px 0;
        }
        .timeline-container::after {
            content: '';
            position: absolute;
            width: 4px;
            background-color: var(--primary-color);
            opacity: 0.3;
            top: 0;
            bottom: 0;
            left: 50%;
            margin-left: -2px;
        }
        .timeline-item {
            padding: 10px 40px;
            position: relative;
            width: 50%;
        }
        .timeline-item::after {
            content: '';
            position: absolute;
            width: 20px;
            height: 20px;
            right: -10px;
            background-color: white;
            border: 4px solid var(--btn-main-color);
            top: 25px;
            border-radius: 50%;
            z-index: 1;
        }
        .timeline-item.left {
            left: 0;
        }
        .timeline-item.right {
            left: 50%;
        }
        .timeline-item.left::before {
            content: " ";
            height: 0;
            position: absolute;
            top: 22px;
            width: 0;
            z-index: 1;
            right: 30px;
            border: medium solid white;
            border-width: 10px 0 10px 10px;
            border-color: transparent transparent transparent white;
        }
        .timeline-item.right::before {
            content: " ";
            height: 0;
            position: absolute;
            top: 22px;
            width: 0;
            z-index: 1;
            left: 30px;
            border: medium solid white;
            border-width: 10px 10px 10px 0;
            border-color: transparent white transparent transparent;
        }
        .timeline-item.right::after {
            left: -10px;
        }
        .timeline-content {
            padding: 15px;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            position: relative;
        }
        .timeline-content img {
            width: 100%;
            height: auto;
            border-radius: 6px;
            cursor: pointer;
        }
        .timeline-content .delete-form {
            display: block;
        }
        
        /* --- CAMBIO 1: Añadir estilo para la fecha en la cronología --- */
        .timeline-date {
            font-weight: bold;
            color: var(--secondary-color);
            margin-bottom: 10px;
            font-size: 0.9em;
        }

        @media screen and (max-width: 768px) {
            .timeline-container::after {
                left: 30px;
            }
            .timeline-item {
                width: 100%;
                padding-left: 70px;
                padding-right: 25px;
            }
            .timeline-item.left, .timeline-item.right {
                left: 0%;
            }
            .timeline-item.left::before, .timeline-item.right::before {
                left: 60px;
                border: medium solid white;
                border-width: 10px 10px 10px 0;
                border-color: transparent white transparent transparent;
            }
            .timeline-item.left::after, .timeline-item.right::after {
                left: 20px;
            }
        }

        /* Estilos del Sidebar */
        .wapper-aside{
                position: fixed;
                width: 10px;
                height: 100%;
                display: grid;
                align-items: center;
                z-index: 100;
            }
            .wapper-aside:hover .sidebar{
                transform: translateX(0);
            }
            .sidebar{
                z-index: 101;
                position: absolute;
                background-color: white;
                width: max-content;
                border-radius: 10px;
                padding:  2rem 1rem;
                transform: translateX(-90%);
                transition: transform .3s ease;
                box-shadow: 0 8px 20px rgba(0, 0, 0, 0.30);
            }
            .sidebar:hover .sidebar_element{
                grid-template-columns: 40px 1fr;
            }
            .sidebar_list{
                list-style: none;
                padding: 0;
                margin-bottom: 0;
                min-height: 400px;
                display: flex;
                flex-direction: column;
                gap: .4rem;
                justify-content: center;
            }
            .sidebar_list a{
            text-decoration: none;
            }
            .sidebar_element{
                padding: .8rem 1.3rem;
                border-radius: 10px;
                display: grid;
                align-items: center;
                grid-template-columns: 40px 0fr;
                color: #526581;
                transition:  grid-template-columns .5s;
            }
            .sidebar_element:hover{
                background-color: #e3b707;
                color: #fff;
                cursor: pointer;
            }
            .sidebar_element a{
            text-decoration: none;
            color: #526581;
            display: flex;
            align-items: center;
            width: 100%;
            }
            .sidebar_element a:hover{
            color: #fff;
            }
            .sidebar_icon{
                width: 100%;
                overflow: hidden;
                justify-self: center;
            }
            .sidebar_text{
                padding-left: 1.3rem;
                text-wrap: nowrap;
                font-size: 1.1rem;
            }
            .sidebar_hide{
                overflow: hidden;
            }
            @media screen and (min-width: 1340px) and (max-width: 1360px){
            .sidebar{
                padding:  1rem .5rem;
            }
            .sidebar_list{
                gap: .2rem;
            }
            .sidebar_element{
                padding: .8rem .8rem;
            }
        }
    </style>
</head>

<body>

    <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="container">
            <a class="navbar-brand nav-link" href="/">
                <i class="bi bi-cpu-fill"></i> RIO ARO Portal
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#mainNav">
                <span class="navbar-toggler-icon"></span>
            </button>
        </div>
    </nav>
  
    <div class="wapper-aside">
        <aside class="sidebar">
        <ul class="sidebar_list">
          <a href="/index">
            <li class="sidebar_element">
                <img src="../assets/icons/regresar.svg" alt="home" class="sidebar_icon" width="35px" height="35px">
                <div class="sidebar_hide">
                    <p class="sidebar_text">Inicio</p>
                </div>
            </li>
          </a>
          <a href="/base_de_datos">
            <li class="sidebar_element">
                <img src="../assets/icons/datos-black.png" alt="estadisticas" class="sidebar_icon" width="20px" height="30px">
                <div class="sidebar_hide">
                    <p class="sidebar_text">Base de datos</p>
                </div>
            </li>
          </a>
          <a href="/comunidades">
              <li class="sidebar_element">
                <img src="../assets/icons/vista rapida-black.png" alt="informe" class="sidebar_icon" width="30px" height="30px">
                <div class="sidebar_hide">
                    <p class="sidebar_text">Jerarquia</p>
                </div>
            </li>
            </a>
            <a href="/historia">
            <li class="sidebar_element">
                <img src="../assets/icons/historial.svg" alt="informe" class="sidebar_icon" width="30px" height="30px">
                
                <div class="sidebar_hide">
                    <p class="sidebar_text">Historial</p>
                </div>
            </li>
          </a>
          <a href="/calendario">
            <li class="sidebar_element">
                <img src="../assets/icons/calendario.svg" alt="calendario" class="sidebar_icon" width="30px" height="30px">
                <div class="sidebar_hide">
                    <p class="sidebar_text">Calendario</p>
                </div>
            </li>
          </a>
          <a href="/galeria">
            <li class="sidebar_element">
                <img src="../assets/icons/galeria.svg" alt="galeria" class="sidebar_icon" width="30px" height="30px">
                <div class="sidebar_hide">
                    <p class="sidebar_text">Galeria</p>
                </div>
            </li>
          </a>
        </ul>
        </aside>
    </div>

    <main class="container">
        <div class="container text-center">
            <h1 class="mb-4">Galería de Imágenes</h1>
            {{if .Messages}}
                <div class="alert alert-info" role="alert">
                    {{range .Messages}}{{.}}<br>{{end}}
                </div>
            {{end}}

            <div class="upload-section">
                <h2>Subir Nueva Imagen</h2>
                <form action="/upload" method="post" enctype="multipart/form-data" class="d-flex justify-content-center align-items-center flex-column flex-md-row">
                    <input type="file" name="file" class="form-control me-md-2 mb-2 mb-md-0" style="max-width: 300px;" required>
                    <button type="submit" class="btn btn-primary"><i class="fas fa-upload me-2"></i>Subir Imagen</button>
                </form>
                <small class="text-muted mt-2">Formatos permitidos: PNG, JPG, JPEG, GIF</small>
            </div>

            <ul class="nav nav-tabs mb-3" id="galleryTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="grid-tab" data-bs-toggle="tab" data-bs-target="#grid-view" type="button" role="tab" aria-controls="grid-view" aria-selected="true">
                        <i class="fas fa-th-large me-2"></i>Galería (Rejilla)
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="timeline-tab" data-bs-toggle="tab" data-bs-target="#timeline-view" type="button" role="tab" aria-controls="timeline-view" aria-selected="false">
                        <i class="fas fa-stream me-2"></i>Cronología
                    </button>
                </li>
            </ul>

            <div class="tab-content" id="galleryTabsContent">
                
                <div class="tab-pane fade show active" id="grid-view" role="tabpanel" aria-labelledby="grid-tab">
                    <div class="gallery-container">
                        {{if .Images}}
                            <!-- CAMBIO 2: Modificar el bucle para usar la nueva estructura de datos -->
                            {{range .Images}}
                            <div class="wii-icon" 
                                 data-bs-toggle="modal" 
                                 data-bs-target="#imageModal" 
                                 data-image-src="/assets/imagenes/{{.Filename}}"
                                 data-upload-date="{{.UploadDate}}"> <!-- Añadimos la fecha como un data attribute -->
                                <img src="/assets/imagenes/{{.Filename}}" class="img-fluid" alt="Galería Imagen">
                                <form action="/delete/{{.Filename}}" method="post" class="delete-form">
                                    <button type="submit" class="delete-btn" title="Eliminar Imagen">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </form>
                            </div>
                            {{end}}
                        {{else}}
                            <p>No hay imágenes en la galería. ¡Sube algunas!</p>
                        {{end}}
                    </div>
                </div>

                <div class="tab-pane fade" id="timeline-view" role="tabpanel" aria-labelledby="timeline-tab">
                    <div class="timeline-container">
                        {{if not .Images}}
                            <p>No hay imágenes en la galería. ¡Sube algunas!</p>
                        {{end}}
                    </div>
                </div>

            </div>
        </div>

        <div class="modal fade" id="imageModal" tabindex="-1" aria-labelledby="imageModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="imageModalLabel">Vista de Imagen</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body text-center">
                        <img src="" class="img-fluid" id="modalImage" alt="Imagen en grande">
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // Script para el Modal (original)
        var imageModal = document.getElementById('imageModal');
        imageModal.addEventListener('show.bs.modal', function (event) {
            var button = event.relatedTarget;
            var imageSrc = button.getAttribute('data-image-src');
            var modalImage = imageModal.querySelector('#modalImage');
            modalImage.src = imageSrc;
        });

        // Script para poblar la Cronología
        document.addEventListener("DOMContentLoaded", function() {
            const galleryContainer = document.querySelector('.gallery-container');
            const timelineContainer = document.querySelector('.timeline-container');
            const images = galleryContainer.querySelectorAll('.wii-icon');
            const reversedImages = Array.from(images).reverse();

            if (reversedImages.length > 0) {
                 timelineContainer.innerHTML = ''; 
            }

            // CAMBIO 3: Modificar el bucle de JavaScript para leer y mostrar la fecha
            reversedImages.forEach((wiiIcon, index) => {
                const originalImg = wiiIcon.querySelector('img');
                const originalDeleteForm = wiiIcon.querySelector('.delete-form');
                
                if (!originalImg) return;

                const imgSrc = originalImg.getAttribute('src');
                const modalSrc = wiiIcon.getAttribute('data-image-src');
                // Obtenemos la fecha del data attribute que añadimos en el HTML
                const uploadDate = wiiIcon.getAttribute('data-upload-date');

                const side = (index % 2 === 0) ? 'left' : 'right';

                const timelineItem = document.createElement('div');
                timelineItem.className = `timeline-item ${side}`;

                // Añadimos un elemento <p> con la fecha dentro del contenido
                timelineItem.innerHTML = `
                    <div class="timeline-content">
                        <p class="timeline-date">${uploadDate || 'Fecha no disponible'}</p>
                        <img src="${imgSrc}" alt="Imagen de cronología" 
                             data-bs-toggle="modal" 
                             data-bs-target="#imageModal" 
                             data-image-src="${modalSrc}">
                        
                        ${originalDeleteForm ? originalDeleteForm.outerHTML : ''}
                    </div>
                `;
                
                timelineContainer.appendChild(timelineItem);
            });
        });
    </script>
</body>
</html>
